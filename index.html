<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KM/CIF Curve Digitizer</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <header>
            <h1>KM/CIF Curve Digitizer</h1>
            <div class="header-buttons">
                <button id="helpBtn" class="btn btn-secondary">Help</button>
                <button id="resetBtn" class="btn btn-danger">Reset</button>
            </div>
        </header>

        <div id="dropZone" class="drop-zone">
            <div class="drop-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
            </div>
            <h2>Load a KM/CIF Curve Image</h2>
            <div class="drop-methods">
                <div class="drop-method">
                    <span class="method-icon">1</span>
                    <span><strong>Drag & Drop</strong> an image here</span>
                </div>
                <div class="drop-method">
                    <span class="method-icon">2</span>
                    <span><strong>Copy image</strong> then press <kbd>Ctrl</kbd>+<kbd>V</kbd></span>
                </div>
                <div class="drop-method">
                    <span class="method-icon">3</span>
                    <span>Or use the buttons below</span>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" hidden>
            <div class="drop-buttons">
                <button id="browseBtn" class="btn btn-primary">Browse Files</button>
                <button id="pasteBtn" class="btn btn-secondary">Paste from Clipboard</button>
            </div>
        </div>

        <main class="main-content" id="mainContent" style="display: none;">
            <div class="canvas-wrapper">
                <div class="canvas-toolbar">
                    <div class="toolbar-left">
                        <button id="undoBtnTop" class="btn btn-small" disabled title="Undo (Ctrl+Z)">
                            <span class="btn-icon">&#8617;</span> Undo
                        </button>
                        <button id="redoBtnTop" class="btn btn-small" disabled title="Redo (Ctrl+Y)">
                            <span class="btn-icon">&#8618;</span> Redo
                        </button>
                    </div>
                    <div class="toolbar-center">
                        <button id="zoomOutBtn" class="btn btn-small" title="Zoom Out">-</button>
                        <span id="zoomLevel">100%</span>
                        <button id="zoomInBtn" class="btn btn-small" title="Zoom In">+</button>
                        <button id="zoomResetBtn" class="btn btn-small" title="Reset Zoom">Fit</button>
                    </div>
                    <div class="toolbar-right">
                        <span id="cursorCoords" class="coords-display">X: -- Y: --</span>
                    </div>
                </div>
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="mainCanvas"></canvas>
                    <div class="canvas-instructions" id="canvasInstructions">
                        Click to set calibration points
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <section class="panel">
                    <h3>Calibration</h3>
                    <div class="calibration-status" id="calibrationStatus">
                        <span class="status-dot pending"></span>
                        <span>Not calibrated</span>
                    </div>
                    <div class="calibration-inputs">
                        <div class="input-group">
                            <label>X-axis (Time)</label>
                            <div class="input-row">
                                <input type="number" id="xMin" placeholder="Min" value="0">
                                <input type="number" id="xMax" placeholder="Max" value="60">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Y-axis (Survival/CIF)</label>
                            <div class="input-row">
                                <input type="number" id="yMin" placeholder="Min" value="0" step="0.1">
                                <input type="number" id="yMax" placeholder="Max" value="1" step="0.1">
                            </div>
                        </div>
                    </div>
                    <button id="calibrateBtn" class="btn btn-primary btn-full">Set Calibration Points</button>
                    <button id="clearCalibrationBtn" class="btn btn-secondary btn-full" style="display:none;">Clear Calibration</button>

                    <div class="grid-controls" id="gridControls" style="display:none;">
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e0e0e0;">
                        <label class="toggle-label">
                            <input type="checkbox" id="gridToggle">
                            <span>Show Grid Overlay</span>
                        </label>
                        <div class="grid-spacing">
                            <div class="input-group">
                                <label>X Grid Spacing</label>
                                <input type="number" id="gridSpacingX" value="10" min="1" step="1">
                            </div>
                            <div class="input-group">
                                <label>Y Grid Spacing</label>
                                <input type="number" id="gridSpacingY" value="0.1" min="0.01" step="0.05">
                            </div>
                        </div>
                    </div>
                </section>

                <section class="panel">
                    <h3>Curves</h3>
                    <div class="mode-toggle">
                        <label class="mode-option">
                            <input type="radio" name="digitizeMode" value="manual" checked>
                            <span>Manual</span>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="digitizeMode" value="auto">
                            <span>Auto-detect</span>
                        </label>
                    </div>
                    <div id="autoSettings" class="auto-settings" style="display: none;">
                        <button id="detectAllBtn" class="btn btn-primary btn-full">
                            Detect All Curves Automatically
                        </button>
                        <div class="divider">or click on a specific curve</div>
                        <div class="input-group">
                            <label>Color Tolerance</label>
                            <input type="range" id="colorTolerance" min="10" max="80" value="30">
                            <span id="toleranceValue">30</span>
                        </div>
                    </div>
                    <div id="curveList" class="curve-list"></div>
                    <button id="addCurveBtn" class="btn btn-primary btn-full">+ Add Curve</button>
                </section>

                <section class="panel">
                    <h3>Points <span id="activeCurveName"></span> <span id="pointCount">(0)</span></h3>
                    <div id="pointsTable" class="points-table">
                        <div class="points-header">
                            <span>Time</span>
                            <span>Value</span>
                            <span></span>
                        </div>
                        <div id="pointsList" class="points-list"></div>
                    </div>
                </section>
            </div>
        </main>

        <footer id="footer" style="display: none;">
            <div class="footer-left">
                <button id="undoBtn" class="btn btn-secondary" disabled title="Undo (Ctrl+Z)">
                    <span class="btn-icon">&#8617;</span> Undo
                </button>
                <button id="redoBtn" class="btn btn-secondary" disabled title="Redo (Ctrl+Y)">
                    <span class="btn-icon">&#8618;</span> Redo
                </button>
            </div>
            <div class="footer-center">
                <span id="statusText">Points: 0 | Curves: 0</span>
            </div>
            <div class="footer-right">
                <button id="copyBtn" class="btn btn-secondary">Copy to Clipboard</button>
                <button id="exportBtn" class="btn btn-primary">Export CSV</button>
            </div>
        </footer>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>How to Use</h2>
            <ol>
                <li><strong>Load an image:</strong> Drag & drop, paste (Ctrl+V), or click Browse</li>
                <li><strong>Calibrate axes:</strong>
                    <ul>
                        <li>Enter the min/max values for X (time) and Y (survival) axes</li>
                        <li>Click "Set Calibration Points"</li>
                        <li>Click 4 points on the image: X-min, X-max, Y-min, Y-max</li>
                    </ul>
                </li>
                <li><strong>Add curves:</strong> Click "+ Add Curve" and give it a name/color</li>
                <li><strong>Digitize points:</strong> Click on the curve to add points</li>
                <li><strong>Edit points:</strong>
                    <ul>
                        <li>Drag points to adjust position</li>
                        <li>Right-click to delete a point</li>
                        <li>Use Undo/Redo buttons</li>
                    </ul>
                </li>
                <li><strong>Export:</strong> Click "Export CSV" or "Copy to Clipboard"</li>
            </ol>
        </div>
    </div>

    <!-- Add Curve Modal -->
    <div id="curveModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <span class="modal-close">&times;</span>
            <h2>Add New Curve</h2>
            <div class="input-group">
                <label for="curveName">Curve Name</label>
                <input type="text" id="curveName" placeholder="e.g., Treatment A">
            </div>
            <div class="input-group">
                <label for="curveColor">Color</label>
                <input type="color" id="curveColor" value="#2196F3">
            </div>
            <button id="saveCurveBtn" class="btn btn-primary btn-full">Add Curve</button>
        </div>
    </div>

    <script src="js/calibration.js"></script>
    <script src="js/curves.js"></script>
    <script src="js/autodetect.js"></script>
    <script src="js/canvas.js"></script>
    <script src="js/export.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
